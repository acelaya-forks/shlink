name: CI setup
description: 'Sets up the environment to run CI actions for Shlink'

inputs:
  install-deps:
    description: 'Tells if dependencies should be installed with composer. Default value is "yes"'
    required: true
    default: 'yes'
  php-version:
    description: 'The PHP version to be setup'
    required: true
  php-extensions:
    description: 'The PHP extensions to install, other than openswoole, which gets installed by default'
    required: true
    default: ''
  extensions-cache-key:
    description: 'The key used to cache PHP extensions. If empty value is provided, extension caching is disabled'
    required: true

runs:
  using: composite
  steps:
    - name: Compute extensions
      id: compute_extensions
      run: |
        COMPUTED_EXTENSIONS="${{ join(inputs.php-extensions != '' && ['openswoole-4.11.1', inputs.php-extensions] || ['openswoole-4.11.1'], ', ') }}" && \
        echo "##[set-output name=php-extensions;]$COMPUTED_EXTENSIONS"
      shell: bash
    - name: Setup cache environment
      id: extensions_cache
      uses: shivammathur/cache-extensions@v1
      with:
        php-version: ${{ inputs.php-version }}
        extensions: ${{ steps.compute_extensions.outputs.php-extensions }}
        key: ${{ inputs.extensions-cache-key }}
    - name: Cache extensions
      uses: actions/cache@v2
      with:
        path: ${{ steps.extensions_cache.outputs.dir }}
        key: ${{ steps.extensions_cache.outputs.key }}
        restore-keys: ${{ steps.extensions_cache.outputs.key }}
    - name: Use PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ inputs.php-version }}
        tools: composer
        extensions: ${{ steps.compute_extensions.outputs.php-extensions }}
        coverage: pcov
        ini-values: pcov.directory=module
    - name: Install dependencies
      if: ${{ inputs.install-deps == 'yes' }}
      run: composer install --no-interaction --prefer-dist
      shell: bash
